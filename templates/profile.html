{% extends 'base.html' %}

{% block title %}Meu Perfil - Zelopack{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title mb-0">Meu Perfil</h2>
                </div>
                <div class="card-body">
                    <div class="user-profile-header mb-4">
                        <div class="user-avatar">
                            {% if current_user.profile_pic %}
                            <img src="{{ current_user.profile_pic }}" alt="{{ current_user.name }}" class="img-fluid rounded-circle">
                            {% else %}
                            {{ current_user.name[:1].upper() }}
                            {% endif %}
                        </div>
                        <div class="user-info">
                            <h2>{{ current_user.name }}</h2>
                            <span class="user-role">{{ current_user.role }}</span>
                            <p class="text-muted mt-2">{{ current_user.email }}</p>
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('auth.profile') }}" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <!-- Name -->
                            <div class="col-md-6">
                                <label for="name" class="form-label">Nome <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ current_user.name }}" required>
                                <div class="invalid-feedback">
                                    Por favor, informe seu nome.
                                </div>
                            </div>
                            
                            <!-- Email (readonly) -->
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" value="{{ current_user.email }}" readonly disabled>
                                <small class="form-text text-muted">O email não pode ser alterado.</small>
                            </div>
                            
                            <!-- Department -->
                            <div class="col-md-6">
                                <label for="department" class="form-label">Departamento</label>
                                <select class="form-select" id="department" name="department">
                                    <option value="">Selecione um departamento</option>
                                    {% for department in config.DEPARTMENTS %}
                                    <option value="{{ department }}" {% if department == current_user.department %}selected{% endif %}>
                                        {{ department }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Role (readonly) -->
                            <div class="col-md-6">
                                <label for="role" class="form-label">Função</label>
                                <input type="text" class="form-control" id="role" value="{{ current_user.role }}" readonly disabled>
                                <small class="form-text text-muted">A função só pode ser alterada por um administrador.</small>
                            </div>
                            
                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-main">Atualizar Perfil</button>
                            </div>
                        </div>
                    </form>
                    
                    <hr class="my-4">
                    
                    <h3 class="mt-4 mb-3">Alterar Senha</h3>
                    <p class="text-muted">Para alterar sua senha, utilize o método de recuperação de senha pelo login.</p>
                    <a href="{{ url_for('auth.reset_password') }}" class="btn btn-outline-primary">
                        <i class="bi bi-key me-1"></i> Redefinir Senha
                    </a>
                </div>
            </div>
            
            <!-- Resources assigned to current user -->
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Meus Recursos</h3>
                </div>
                <div class="card-body">
                    <div id="my-resources">
                        <!-- This would be populated with resources assigned to the current user -->
                        <div class="text-center py-4">
                            <i class="bi bi-inbox display-1 text-muted"></i>
                            <p class="mt-3">Você não possui recursos atribuídos no momento</p>
                            <a href="{{ url_for('resources.index') }}" class="btn btn-primary mt-2">
                                Ver recursos disponíveis
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
    
    // Fetch assigned resources (this would be replaced with actual data)
    // In a real implementation, this data would be passed from the backend
    const userId = '{{ current_user.id }}';
    
    // This is a placeholder. In a real implementation, you'd load this data from the backend
    // and wouldn't need this JavaScript code at all
    const myResourcesContainer = document.getElementById('my-resources');
    
    // Example of how you might structure assigned resources if they were available
    // Note: In a proper implementation, this would be rendered server-side in the template
    /*
    if (myResourcesContainer && myResources && myResources.length > 0) {
        // Clear the placeholder
        myResourcesContainer.innerHTML = '';
        
        // Create a table for my resources
        const tableHTML = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Local</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${myResources.map(resource => `
                            <tr>
                                <td>${resource.name}</td>
                                <td>${resource.category}</td>
                                <td>${resource.location}</td>
                                <td>
                                    <a href="/resources/${resource.id}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <form method="POST" action="/resources/${resource.id}/release" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-success" title="Liberar recurso">
                                            <i class="bi bi-check2-circle"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        myResourcesContainer.innerHTML = tableHTML;
    }
    */
});
</script>
{% endblock %}
